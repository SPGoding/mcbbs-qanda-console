<!doctype html><title>MCBBS 问答版月度活动管理后台</title><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" name=viewport><style>html{background-color:#fefefe}a{color:#07a}#manage,#preview{font-size:16px;max-width:1024px;min-width:60%;margin:0 auto;padding:1em}.card{box-shadow:0 4px .5em 0 rgba(0,0,0,.2);transition:.3s;padding:1em}.card:hover{box-shadow:0 8px 1em 0 rgba(0,0,0,.2)}pre{background:#f8f8ff;border:#000 dashed 1px;padding:.5em;margin-bottom:1em;overflow-x:auto}button{border:none;color:#fff;padding:15px 32px;text-align:center;display:inline-block;font-size:16px;margin:8px}button{background-color:#ddd}button:hover{background-color:#ededed}button:active{background-color:#cdcdcd}.primary{background-color:#008cba}.primary:hover{background-color:#109cba}.primary:active{background-color:#007c9a}.warning{background-color:#81157d}.warning:hover{background-color:#91258d}.warning:active{background-color:#71056d}.small{font-size:12px;padding:1em;margin:.5em 0;text-align:center;display:inline-block}#rank-image{max-width:100%}#users{font-family:"Trebuchet MS",Arial,Helvetica,sans-serif;border-collapse:collapse;width:100%}#users td,#users th{border:1px solid #ddd}#users tr:nth-child(even){background-color:#f2f2f2}#users tr:hover{background-color:#ddd}#users th:hover{background-color:#3c9f40}#users th{padding-top:1em;padding-bottom:1em;background-color:#4caf50;color:#fff}dialog{position:fixed}table{table-layout:fixed}</style><body style=text-align:center><dialog id=add-user-dialog><h1>添加用户</h1><div style=text-align:right>UID：<input id=add-user-dialog-uid placeholder=UID><br>初始爱心数量：<input id=add-user-dialog-heart-initial placeholder=留空自动获取><br></div><button onclick=confirmAddUser() type=button class=primary>添加</button><button onclick="addUserDialog.open=!1" type=button>取消</button></dialog><dialog id=edit-user-dialog><h1 id=edit-user-dialog-title>编辑用户</h1><div style=text-align:right>UID：<input id=edit-user-dialog-uid placeholder=UID><br>初始爱心：<input id=edit-user-dialog-heart-initial placeholder=初始爱心数量 value=${user.heartInitial}><br>放弃爱心：<input id=edit-user-dialog-heart-abandoned placeholder=放弃爱心数量 value=${user.heartAbandoned}><br></div>禁赛：<input id=edit-user-dialog-banned type=checkbox><br><button onclick=confirmEditUser() type=button class=primary>确定</button><button onclick="editUserDialog.open=!1" type=button>取消</button></dialog><dialog id=edit-const-dialog><h1>编辑常数</h1><div style=text-align:right>第一名爱心最低要求（满足的第一名用户爱心数将显示为红色，设为 -1 禁用此功能）：<input id=edit-const-dialog-minimum-heart-first-place><br>第二至九名爱心最低要求（未满足的用户所在行将显示为灰色，设为 -1 禁用此功能）：<input id=edit-const-dialog-minimum-heart><br>每两轮统计之间的最短间隔时间（单位：毫秒。不好意思，只能在服务器上改 QwQ）：<input id=edit-const-dialog-interval readonly><br>每统计两名用户的最短间隔时间（单位：毫秒。不好意思，只能在服务器上改 QwQ）：<input id=edit-const-dialog-sleep readonly><br></div><button onclick=confirmEditConst() type=button class=primary>确定</button><button onclick="editConstDialog.open=!1" type=button>取消</button></dialog><div id=manage class=card><h1>管理</h1><div id=logged-out><p>您需要登录才能进行管理…</p><input id=password placeholder=密码 type=password><br><input id=to-save-password type=checkbox>记住密码<br><button onclick=login() type=button class=primary>登录</button></div><div id=logged-in style=display:none><p>欢迎您，问答大区版主，<a href=# onclick=logout()>点此登出</a>。</p><button onclick=editConst() type=button class=primary>编辑常数</button><button onclick=toggleShowingRankImage() type=button class=warning>切换公示</button><br><button onclick=addUser() type=button class=primary>添加用户</button><table id=users><tr><th onclick=sortTable(0)>UID<th onclick=sortTable(1)>用户名<th onclick=sortTable(2)>初始爱心<th onclick=sortTable(3)>放弃爱心<th onclick=sortTable(4)>当前爱心<th onclick=sortTable(5)>获取爱心<th onclick=sortTable(6)>禁赛<th>操作</table></div></div><div id=preview class=card><h1>预览</h1><h2>爱心数目统计表</h2><img id=rank-image><pre id=rank-image-bbcode>加载中…</pre><hr><h2>今日爱心增量条形统计图</h2><img id=increase-image><pre id=increase-image-bbcode>制作中…</pre><hr><h2>近日爱心数目折线统计图</h2><img id=heart-image><pre id=heart-image-bbcode>制作中…</pre><hr><h2>一吨特性随叫随加...</h2>什么也不要，只要版主姐姐的抱抱！<br>没有抱抱给贡献献也可以！<br>MCBBS:<a href=http://www.mcbbs.net/?2444378 target=_blank>@SPGoding</a><br>GitHub:<a href=https://github.com/SPGoding/mcbbs-qanda-console target=_blank>mcbbs-qanda-console</a></div><script>'use strict'
        // Constants
        const url = '%{serverUrl}%' // This will be replaced by server side.
        const api = {
            getRankImage: 'api/get-rank-image',
            getIncreaseImage: 'api/get-increase-image',
            getHeartImage: 'api/get-heart-image',
            getRegistrationBBCode: 'api/get-registration-bbcode',
            getUsers: 'api/get-users',
            login: 'api/login',
            addUser: 'api/add-user',
            editUser: 'api/edit-user',
            delUser: 'api/del-user',
            toggleShowingRankImage: 'api/toggle-showing-rank-image',
            editConsts: 'api/edit-consts',
            getConsts: 'api/get-consts'
        }

        // Get elements
        const loggedOut = document.getElementById('logged-out')
        const loggedIn = document.getElementById('logged-in')
        const rankImage = document.getElementById('rank-image')
        const rankImageBBCode = document.getElementById('rank-image-bbcode')
        const increaseImage = document.getElementById('increase-image')
        const increaseImageBBCode = document.getElementById('increase-image-bbcode')
        const heartImage = document.getElementById('heart-image')
        const heartImageBBCode = document.getElementById('heart-image-bbcode')
        const password = document.getElementById('password')
        const toSavePassword = document.getElementById('to-save-password')
        const addUserDialog = document.getElementById('add-user-dialog')
        const addUserDialogUid = document.getElementById('add-user-dialog-uid')
        const addUserDialogHeartInitial = document.getElementById('add-user-dialog-heart-initial')
        const editUserDialog = document.getElementById('edit-user-dialog')
        const editUserDialogTitle = document.getElementById('edit-user-dialog-title')
        const editUserDialogUid = document.getElementById('edit-user-dialog-uid')
        const editUserDialogHeartInitial = document.getElementById('edit-user-dialog-heart-initial')
        const editUserDialogHeartAbandoned = document.getElementById('edit-user-dialog-heart-abandoned')
        const editUserDialogBanned = document.getElementById('edit-user-dialog-banned')
        const usersTable = document.getElementById('users')
        const editConstDialog = document.getElementById('edit-const-dialog')
        const editConstDialogMinimumHeart = document.getElementById('edit-const-dialog-minimum-heart')
        const editConstDialogMinimumHeartFirstPlace = document.getElementById('edit-const-dialog-minimum-heart-first-place')
        const editConstDialogInterval = document.getElementById('edit-const-dialog-interval')
        const editConstDialogSleep = document.getElementById('edit-const-dialog-sleep')

        // Other data
        let users

        // Set BBCodes
        rankImageBBCode.innerHTML = `[img=554,260]${url}/${api.getRankImage}[/img]`
        increaseImageBBCode.innerHTML = `[img=400,432]${url}/${api.getIncreaseImage}[/img]`
        heartImageBBCode.innerHTML = `[img=500,400]${url}/${api.getHeartImage}[/img]`

        // Auto login
        {
            const pwd = window.localStorage.getItem('savedPassword')
            if (pwd) {
                toSavePassword.checked = true
                password.value = pwd
                login()
            }
        }

        async function login() {
            if (toSavePassword.checked) {
                window.localStorage.setItem('savedPassword', password.value)
            }
            const response = await request('POST', api.login, `password=${password.value}`)
            if (response === 'S') {
                setIsLoggedIn(true)
            } else {
                password.value = ''
                window.localStorage.clear()
                alert('密码错误')
            }
        }

        async function logout() {
            setIsLoggedIn(false)
            password.value = ''
            window.localStorage.clear()
        }

        function setIsLoggedIn(bool) {
            if (bool) {
                loggedIn.style.display = ''
                loggedOut.style.display = 'none'
            } else {
                loggedIn.style.display = 'none'
                loggedOut.style.display = ''
            }
        }

        // Update
        updateAll()
        setInterval(updateAll, 60000)
        async function updateAll() {
            rankImage.src = `${url}/${api.getRankImage}?t=${new Date().getTime()}`
            increaseImage.src = `${url}/${api.getIncreaseImage}?t=${new Date().getTime()}`
            heartImage.src = `${url}/${api.getHeartImage}?t=${new Date().getTime()}`
            await getUsers()
            await getConsts()
        }

        async function getUsers() {
            const jsonArray = JSON.parse(await request('GET', api.getUsers))
            users = []
            for (const uid in jsonArray) {
                users.push({ ...jsonArray[uid], uid: Number(uid) })
            }
            usersTable.innerHTML = `<table id="users">
                <tr>
                    <th onclick="sortTable(0)">UID</th>
                    <th onclick="sortTable(1)">用户名</th>
                    <th onclick="sortTable(2)">初始爱心</th>
                    <th onclick="sortTable(3)">放弃爱心</th>
                    <th onclick="sortTable(4)">当前爱心</th>
                    <th onclick="sortTable(5)">获取爱心</th>
                    <th onclick="sortTable(6)">禁赛</th>
                    <th>操作</th>
                </tr>
            </table>`
            for (const user of users) {
                const row = usersTable.insertRow(-1)
                const uid = row.insertCell(0)
                const username = row.insertCell(1)
                const heartInitial = row.insertCell(2)
                const heartAbandoned = row.insertCell(3)
                const heartPresent = row.insertCell(4)
                const heartAttained = row.insertCell(5)
                const banned = row.insertCell(6)
                const operations = row.insertCell(7)
                uid.innerHTML = user.uid
                username.innerHTML = user.username
                heartInitial.innerHTML = user.heartInitial
                heartAbandoned.innerHTML = user.heartAbandoned
                heartPresent.innerHTML = user.heartPresent
                heartAttained.innerHTML = user.heartAttained
                banned.innerHTML = user.banned ? '是' : '否'
                operations.innerHTML =
                    `<button type="button" onclick="editUser(${user.uid})" class="primary small">編輯</button>
<button type="button" onclick="delUser(${user.uid})" class="warning small">删除</button>`
            }
        }

        async function getConsts() {
            const result = JSON.parse(await request('GET', api.getConsts))
            editConstDialogSleep.value = result.sleep
            editConstDialogInterval.value = result.interval
            editConstDialogMinimumHeart.value = result.minimumHeart
            editConstDialogMinimumHeartFirstPlace.value = result.minimumHeartFirstPlace
        }

        async function toggleShowingRankImage() {
            const response = await request('POST', api.toggleShowingRankImage, `password=${password.value}`)
            if (response === 'S') {
                await updateAll()
            } else {
                alert(response)
            }
        }

        function addUser() {
            addUserDialogUid.value = ''
            addUserDialogHeartInitial.value = ''
            addUserDialog.open = true
        }

        async function confirmAddUser() {
            let result
            if (addUserDialogHeartInitial.value !== '') {
                result = await request('POST', api.addUser, `password=${password.value}&uid=${
                    addUserDialogUid.value}&heartInitial=${addUserDialogHeartInitial.value}`)
            } else {
                result = await request('POST', api.addUser, `password=${password.value}&uid=${addUserDialogUid.value}`)
            }
            await updateAll()
            if (result === 'S') {
                addUserDialog.open = false
            } else {
                alert('添加用户时出现错误，请检查 UID 是否正确等')
            }
        }

        function editUser(uid) {
            const user = users.find(v => v.uid === uid)
            editUserDialogTitle.innerHTML = `编辑用户 @${user.username}`
            editUserDialogUid.value = uid
            editUserDialogHeartInitial.value = user.heartInitial
            editUserDialogHeartAbandoned.value = user.heartAbandoned
            editUserDialogBanned.checked = user.banned
            editUserDialog.open = true
        }

        async function confirmEditUser() {
            await request('POST', api.editUser, `password=${password.value}&uid=${editUserDialogUid.value
                }&heartInitial=${editUserDialogHeartInitial.value}&heartAbandoned=${editUserDialogHeartAbandoned.value
                }&banned=${editUserDialogBanned.checked}`)
            await updateAll()
            editUserDialog.open = false
        }

        function editConst() {
            editConstDialog.open = true
        }

        async function confirmEditConst() {
            const response = await request('POST', api.editConsts, `password=${password.value}&minimumHeart=${editConstDialogMinimumHeart.value
                }&minimumHeartFirstPlace=${editConstDialogMinimumHeartFirstPlace.value}`)
            await updateAll()
            if (response === 'S') {
                editConstDialog.open = false
            } else {
                alert(`编辑常数时出现错误: ${response}`)
            }
        }

        async function delUser(uid) {
            await request('POST', api.delUser, `password=${password.value}&uid=${uid}`)
            await updateAll()
        }

        async function request(method, api, message) {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest()
                xhr.onreadystatechange = () => {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        resolve(xhr.responseText)
                    }
                }
                xhr.open(method, `${url}/${api}`)
                xhr.send(message)
            })
        }

        /**
         * https://www.w3schools.com/howto/howto_js_sort_table.asp
         */
        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0
            table = document.getElementById("users")
            switching = true
            // Set the sorting direction to ascending:
            dir = "asc"
            /* Make a loop that will continue until
            no switching has been done: */
            while (switching) {
                // Start by saying: no switching is done:
                switching = false
                rows = table.rows
                /* Loop through all table rows (except the
                first, which contains table headers): */
                for (i = 1; i < (rows.length - 1); i++) {
                    // Start by saying there should be no switching:
                    shouldSwitch = false
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[n]
                    y = rows[i + 1].getElementsByTagName("TD")[n]
                    /* Check if the two rows should switch place,
                    based on the direction, asc or desc: */
                    if (parseFloat(x.innerHTML) !== parseFloat(x.innerHTML) ||
                        parseFloat(y.innerHTML) !== parseFloat(y.innerHTML)) {
                        // parseFloat({v}.innerHTML) is NaN
                        if (dir == "asc") {
                            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true
                                break
                            }
                        } else if (dir == "desc") {
                            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true
                                break
                            }
                        }
                    } else {
                        if (dir == "asc") {
                            if (parseFloat(x.innerHTML) < parseFloat(y.innerHTML)) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true
                                break
                            }
                        } else if (dir == "desc") {
                            if (parseFloat(x.innerHTML) > parseFloat(y.innerHTML)) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true
                                break
                            }
                        }
                    }
                }
                if (shouldSwitch) {
                    /* If a switch has been marked, make the switch
                    and mark that a switch has been done: */
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i])
                    switching = true
                    // Each time a switch is done, increase this count by 1:
                    switchcount++
                } else {
                    /* If no switching has been done AND the direction is "asc",
                    set the direction to "desc" and run the while loop again. */
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc"
                        switching = true
                    }
                }
            }
        }</script>